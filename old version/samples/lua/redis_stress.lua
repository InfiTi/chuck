local chuck = require("chuck")
local engine = chuck.engine()
local signal = chuck.signal

local function sigint_handler()
	print("recv sigint")
	engine:Stop()
end

local signaler = signal.signaler(signal.SIGINT)

local count = 0
local request = 0
local response = 0
local max = 5000000

for j=1,10 do
	local err,client = chuck.redis.Connect(engine,"127.0.0.1",6379)
	if client then
		local function gen_callback(cb,ud)
			return function (conn,reply)
				cb(conn,reply,ud)
			end
		end

		local function pop_cb(conn,reply,id)
			count = count + 1
			response = response + 1
			if response < max then
				request = request + 2
				local cmd = string.format("LPUSH list %d",reply)
				client:Execute(cmd,function ()
					count = count + 1
					response = response + 1			
				end)
				cmd = string.format("lpop list")
				client:Execute(cmd,gen_callback(pop_cb))
			end					
		end

		local function incr_cb(conn,reply,id)
			count = count + 1
			response = response + 1
			if response < max then
				request = request + 1				
				local cmd = string.format("INCR counter")
			    client:Execute(cmd,gen_callback(incr_cb))
			end
		end

		local function query_cb(conn,reply,id)
			count = count + 1
			response = response + 1
			if response < max then
				request = request + 1					
				local cmd = string.format("hmget chaid:%d chainfo skills",id)
			    client:Execute(cmd,gen_callback(query_cb,id))
		  	end	
		end

		client:Execute('HSET UnionPK_201508031_JoinedUser_Formation 3642 [{"pos4HeroId":"13889","pos2":{"level":"7","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"28","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"艾伦","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":945,"evoLevel":"3","magOutPutAdd":0,"att":814,"advLevel":"0","dodge":55,"rebound":0,"ignoreDodge":50,"crit":60,"completePhyDef":0,"magDef":562,"hp":8083,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["2803","1","1"],"2":["2802","1","1"],"1":["2801","1","1"],"10":["2810","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13890","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":560},"speed":1374,"userId":"3642","pos1HeroId":"13885","pos4":{"level":"15","magHarmAddRate":0,"critHarm":1600,"lifeStealRate":0,"heroId":"27","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"藏剑","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":940,"evoLevel":"3","magOutPutAdd":0,"att":1246,"advLevel":"0","dodge":42,"rebound":0,"ignoreDodge":50,"crit":80,"completePhyDef":0,"magDef":651,"hp":8881,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["2703","1","1"],"2":["2702","1","1"],"1":["2701","1","1"],"10":["2710","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13889","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":649},"echelon":"1","userPetId":"157","userPetInfo":{"level":"18","isSelling":"0","userId":"3642","isNew":"1","addTime":"1434535563","petSkillList":[{"level":"18","userPetSkillId":"393","userId":"3642","isNew":"1","petSkillId":"1","userPetId":"157"},{"level":"18","userPetSkillId":"400","userId":"3642","isNew":"1","petSkillId":"2","userPetId":"157"}],"petId":"1","userPetId":"157","aptitudeJson":{"speedAddRate":13,"magDefAddRate":15,"hpAddRate":21,"attAddRate":15,"phyDefAddRate":14},"evoLevel":"2","levelCredits":"171074","addAptitudeJson":{"speedAddRate":0,"magDefAddRate":0,"hpAddRate":0,"attAddRate":0,"phyDefAddRate":0},"isBind":"0"},"pos3HeroId":"13865","pos1":{"level":"9","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"21","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"魔丽莎","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":935,"evoLevel":"3","magOutPutAdd":0,"att":971,"advLevel":"0","dodge":50,"rebound":0,"ignoreDodge":50,"crit":90,"completePhyDef":0,"magDef":549,"hp":8209,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["2103","1","1"],"2":["2102","1","1"],"1":["2101","1","1"],"10":["2110","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13885","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":547},"userName":"紫罗兰末日堕天使","pos3":{"level":"32","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"26","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"伊莲娜","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":955,"evoLevel":"2","magOutPutAdd":0,"att":2022,"advLevel":"4","dodge":50,"rebound":0,"ignoreDodge":50,"crit":250,"completePhyDef":0,"magDef":1167,"hp":12542,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"2":["2602","32","1"],"10":["2610","32","1"],"1":["2601","32","5"]},"morale":15,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13865","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":1191},"pos2HeroId":"13890","userUnionPkFormationId":"428"},{"pos4HeroId":"13867","pos2":{"level":"9","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"1","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"安妮","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":930,"evoLevel":"3","magOutPutAdd":0,"att":742,"advLevel":"0","dodge":60,"rebound":0,"ignoreDodge":50,"crit":80,"completePhyDef":0,"magDef":487,"hp":5125,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["103","1","1"],"2":["102","1","1"],"1":["101","1","1"],"10":["110","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13866","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":487},"speed":828,"userId":"3642","pos1HeroId":"13872","pos4":{"level":"36","magHarmAddRate":0,"critHarm":1800,"lifeStealRate":0,"heroId":"2","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"尤妮斯","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":1000,"evoLevel":"3","magOutPutAdd":0,"att":3125,"advLevel":"2","dodge":50,"rebound":0,"ignoreDodge":50,"crit":60,"completePhyDef":0,"magDef":1300,"hp":12358,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["203","36","1"],"2":["202","36","1"],"1":["201","36","3"],"10":["210","36","1"]},"morale":20,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13867","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":1625},"echelon":"2","userPetId":"159","userPetInfo":{"level":"1","isSelling":"0","userId":"3642","isNew":"1","addTime":"1434989103","petSkillList":[{"level":"1","userPetSkillId":"395","userId":"3642","isNew":"1","petSkillId":"8","userPetId":"159"}],"petId":"3","userPetId":"159","aptitudeJson":{"speedAddRate":0,"magDefAddRate":0,"hpAddRate":0,"attAddRate":0,"phyDefAddRate":0},"evoLevel":"1","levelCredits":"0","addAptitudeJson":{"speedAddRate":0,"magDefAddRate":0,"hpAddRate":0,"attAddRate":0,"phyDefAddRate":0},"isBind":"0"},"pos3HeroId":"13869","pos1":{"level":"1","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"7","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"托雷斯","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":930,"evoLevel":"3","magOutPutAdd":0,"att":520,"advLevel":"0","dodge":50,"rebound":0,"ignoreDodge":50,"crit":100,"completePhyDef":0,"magDef":309,"hp":3786,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["703","1","1"],"2":["702","1","1"],"1":["701","1","1"],"10":["710","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13872","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":309},"userName":"紫罗兰末日堕天使","pos3":{"level":"12","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"4","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"佐佐木","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":950,"evoLevel":"3","magOutPutAdd":0,"att":957,"advLevel":"0","dodge":40,"rebound":0,"ignoreDodge":50,"crit":80,"completePhyDef":0,"magDef":497,"hp":5190,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["403","1","1"],"2":["402","1","1"],"1":["401","1","1"],"10":["410","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13869","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":497},"pos2HeroId":"13866","userUnionPkFormationId":"435"},{"pos4HeroId":"13864","pos2":{"level":"4","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"13","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"奥尔瑟雅","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":940,"evoLevel":"2","magOutPutAdd":0,"att":288,"advLevel":"0","dodge":65,"rebound":0,"ignoreDodge":50,"crit":50,"completePhyDef":0,"magDef":159,"hp":1204,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["1303","1","1"],"2":["1302","1","1"],"1":["1301","1","1"],"10":["1310","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13878","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":159},"speed":0,"userId":"3642","pos1HeroId":"13886","pos4":{"level":"32","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"24","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"薇薇安","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":979,"evoLevel":"2","magOutPutAdd":0,"att":2235,"advLevel":"4","dodge":67,"rebound":0,"ignoreDodge":50,"crit":95,"completePhyDef":0,"magDef":992,"hp":6891,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"2":["2402","32","1"],"10":["2410","32","1"],"1":["2401","32","5"]},"morale":35,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13864","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":860},"echelon":"3","userPetId":"0","userPetInfo":{},"pos3HeroId":"13881","pos1":{"level":"2","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"22","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"路西亚","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":948,"evoLevel":"2","magOutPutAdd":0,"att":255,"advLevel":"0","dodge":48,"rebound":0,"ignoreDodge":50,"crit":68,"completePhyDef":0,"magDef":113,"hp":806,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["2203","1","1"],"2":["2202","1","1"],"1":["2201","1","1"],"10":["2210","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13886","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":113},"userName":"紫罗兰末日堕天使","pos3":{"level":"13","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"16","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"索尼亚","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":930,"evoLevel":"3","magOutPutAdd":0,"att":762,"advLevel":"0","dodge":65,"rebound":0,"ignoreDodge":50,"crit":70,"completePhyDef":0,"magDef":293,"hp":2232,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["1603","1","1"],"2":["1602","1","1"],"1":["1601","1","1"],"10":["1610","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13881","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":293},"pos2HeroId":"13878","userUnionPkFormationId":"436"},{"pos4HeroId":"13873","pos2":{"level":"14","magHarmAddRate":0,"critHarm":1300,"lifeStealRate":0,"heroId":"23","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"诺埃尔","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":960,"evoLevel":"1","magOutPutAdd":0,"att":510,"advLevel":"0","dodge":60,"rebound":0,"ignoreDodge":50,"crit":35,"completePhyDef":0,"magDef":29,"hp":2289,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["2303","1","1"],"2":["2302","1","1"],"1":["2301","1","1"],"10":["2310","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13887","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":296},"speed":0,"userId":"3642","pos1HeroId":"13896","pos4":{"level":"1","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"8","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"雪莉","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":930,"evoLevel":"2","magOutPutAdd":0,"att":207,"advLevel":"0","dodge":75,"rebound":0,"ignoreDodge":50,"crit":50,"completePhyDef":0,"magDef":105,"hp":759,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["803","1","1"],"2":["802","1","1"],"1":["801","1","1"],"10":["810","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13873","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":105},"echelon":"4","userPetId":"0","userPetInfo":{},"pos3HeroId":"13876","pos1":{"level":"14","magHarmAddRate":0,"critHarm":1750,"lifeStealRate":0,"heroId":"35","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"佐伊","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":965,"evoLevel":"1","magOutPutAdd":0,"att":646,"advLevel":"0","dodge":20,"rebound":0,"ignoreDodge":50,"crit":60,"completePhyDef":0,"magDef":247,"hp":1714,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["3503","1","1"],"2":["3502","1","1"],"1":["3501","1","1"],"10":["3510","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13896","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":247},"userName":"紫罗兰末日堕天使","pos3":{"level":"1","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"11","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"伊巴卡","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":930,"evoLevel":"2","magOutPutAdd":0,"att":227,"advLevel":"0","dodge":30,"rebound":0,"ignoreDodge":50,"crit":140,"completePhyDef":0,"magDef":74,"hp":738,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["1103","1","1"],"2":["1102","1","1"],"1":["1101","1","1"],"10":["1110","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13876","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":95},"pos2HeroId":"13887","userUnionPkFormationId":"437"},{"pos4HeroId":"13862","pos2":{"level":"21","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"33","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"叮当","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":940,"evoLevel":"2","magOutPutAdd":0,"att":902,"advLevel":"2","dodge":60,"rebound":0,"ignoreDodge":50,"crit":60,"completePhyDef":0,"magDef":533,"hp":4118,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"1":["3301","20","1"],"10":["3310","20","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13863","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":533},"speed":0,"userId":"3642","pos1HeroId":"13882","pos4":{"level":"35","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"18","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"爱德华","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":945,"evoLevel":"3","magOutPutAdd":0,"att":3592,"advLevel":"4","dodge":55,"rebound":0,"ignoreDodge":50,"crit":90,"completePhyDef":0,"magDef":1358,"hp":12436,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"2":["1802","35","1"],"10":["1810","35","1"],"1":["1801","35","5"]},"morale":50,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13862","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":1525},"echelon":"5","userPetId":"0","userPetInfo":{},"pos3HeroId":"13895","pos1":{"level":"11","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"17","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"阿狸","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":950,"evoLevel":"2","magOutPutAdd":0,"att":564,"advLevel":"0","dodge":55,"rebound":0,"ignoreDodge":50,"crit":50,"completePhyDef":0,"magDef":243,"hp":2084,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["1703","1","1"],"2":["1702","1","1"],"1":["1701","1","1"],"10":["1710","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13882","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":189},"userName":"紫罗兰末日堕天使","pos3":{"level":"1","magHarmAddRate":0,"critHarm":1580,"lifeStealRate":0,"heroId":"34","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"爱德拉","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":980,"evoLevel":"3","magOutPutAdd":0,"att":260,"advLevel":"0","dodge":30,"rebound":0,"ignoreDodge":50,"crit":35,"completePhyDef":0,"magDef":113,"hp":732,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["3403","1","1"],"2":["3402","1","1"],"1":["3401","1","1"],"10":["3410","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13895","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":113},"pos2HeroId":"13863","userUnionPkFormationId":"438"},{"pos4HeroId":"13880","pos2":{"level":"1","magHarmAddRate":0,"critHarm":1550,"lifeStealRate":0,"heroId":"29","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"沃夫","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":948,"evoLevel":"1","magOutPutAdd":0,"att":209,"advLevel":"0","dodge":30,"rebound":0,"ignoreDodge":50,"crit":95,"completePhyDef":0,"magDef":91,"hp":535,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["2903","1","1"],"2":["2902","1","1"],"1":["2901","1","1"],"10":["2910","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13891","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":91},"speed":0,"userId":"3642","pos1HeroId":"13877","pos4":{"level":"3","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"15","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"查尔斯","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":940,"evoLevel":"1","magOutPutAdd":0,"att":248,"advLevel":"0","dodge":60,"rebound":0,"ignoreDodge":50,"crit":60,"completePhyDef":0,"magDef":113,"hp":922,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["1503","1","1"],"2":["1502","1","1"],"1":["1501","1","1"],"10":["1510","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13880","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":113},"echelon":"6","userPetId":"0","userPetInfo":{},"pos3HeroId":"13884","pos1":{"level":"1","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"12","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"格拉蒂丝","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":960,"evoLevel":"1","magOutPutAdd":0,"att":146,"advLevel":"0","dodge":10,"rebound":0,"ignoreDodge":50,"crit":120,"completePhyDef":0,"magDef":86,"hp":739,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["1203","1","1"],"2":["1202","1","1"],"1":["1201","1","1"],"10":["1210","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13877","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":133},"userName":"紫罗兰末日堕天使","pos3":{"level":"1","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"20","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"阿福","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":955,"evoLevel":"1","magOutPutAdd":0,"att":170,"advLevel":"0","dodge":40,"rebound":0,"ignoreDodge":50,"crit":70,"completePhyDef":0,"magDef":95,"hp":711,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["2003","1","1"],"2":["2002","1","1"],"1":["2001","1","1"],"10":["2010","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13884","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":95},"pos2HeroId":"13891","userUnionPkFormationId":"439"},{"pos4HeroId":"13892","pos2":{"level":"9","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"25","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"凯丽","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":948,"evoLevel":"1","magOutPutAdd":0,"att":424,"advLevel":"0","dodge":46,"rebound":0,"ignoreDodge":50,"crit":72,"completePhyDef":0,"magDef":194,"hp":1580,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["2503","1","1"],"2":["2502","1","1"],"1":["2501","1","1"],"10":["2510","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13888","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":194},"speed":0,"userId":"3642","pos1HeroId":"13870","pos4":{"level":"1","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"30","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"大大","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":950,"evoLevel":"1","magOutPutAdd":0,"att":132,"advLevel":"0","dodge":30,"rebound":0,"ignoreDodge":50,"crit":100,"completePhyDef":0,"magDef":133,"hp":629,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["3003","1","1"],"2":["3002","1","1"],"1":["3001","1","1"],"10":["3010","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13892","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":133},"echelon":"7","userPetId":"0","userPetInfo":{},"pos3HeroId":"13893","pos1":{"level":"10","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"5","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"安琪儿","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":930,"evoLevel":"1","magOutPutAdd":0,"att":429,"advLevel":"0","dodge":50,"rebound":0,"ignoreDodge":50,"crit":100,"completePhyDef":0,"magDef":230,"hp":1664,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["503","1","1"],"2":["502","1","1"],"1":["501","1","1"],"10":["510","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13870","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":230},"userName":"紫罗兰末日堕天使","pos3":{"level":"1","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"31","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"安东尼","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":950,"evoLevel":"1","magOutPutAdd":0,"att":216,"advLevel":"0","dodge":35,"rebound":0,"ignoreDodge":50,"crit":90,"completePhyDef":0,"magDef":76,"hp":602,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["3103","1","1"],"2":["3102","1","1"],"1":["3101","1","1"],"10":["3110","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13893","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":76},"pos2HeroId":"13888","userUnionPkFormationId":"441"},{"pos4HeroId":"13868","pos2":{"level":"1","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"19","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"艾伯纳","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":960,"evoLevel":"1","magOutPutAdd":0,"att":149,"advLevel":"0","dodge":50,"rebound":0,"ignoreDodge":50,"crit":40,"completePhyDef":0,"magDef":119,"hp":667,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["1903","1","1"],"2":["1902","1","1"],"1":["1901","1","1"],"10":["1910","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13883","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":119},"speed":0,"userId":"3642","pos1HeroId":"13879","pos4":{"level":"9","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"3","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"莫尔斯","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":950,"evoLevel":"1","magOutPutAdd":0,"att":449,"advLevel":"0","dodge":30,"rebound":0,"ignoreDodge":50,"crit":100,"completePhyDef":0,"magDef":205,"hp":1366,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["303","1","1"],"2":["302","1","1"],"1":["301","1","1"],"10":["310","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13868","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":205},"echelon":"8","userPetId":"0","userPetInfo":{},"pos3HeroId":"13875","pos1":{"level":"1","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"14","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"安斯艾尔","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":950,"evoLevel":"1","magOutPutAdd":0,"att":141,"advLevel":"0","dodge":50,"rebound":0,"ignoreDodge":50,"crit":60,"completePhyDef":0,"magDef":86,"hp":897,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["1403","1","1"],"2":["1402","1","1"],"1":["1401","1","1"],"10":["1410","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13879","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":86},"userName":"紫罗兰末日堕天使","pos3":{"level":"10","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"10","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"艾琳诺","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":980,"evoLevel":"1","magOutPutAdd":0,"att":456,"advLevel":"0","dodge":25,"rebound":0,"ignoreDodge":50,"crit":50,"completePhyDef":0,"magDef":219,"hp":1612,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["1003","1","1"],"2":["1002","1","1"],"1":["1001","1","1"],"10":["1010","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13875","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":219},"pos2HeroId":"13883","userUnionPkFormationId":"442"},{"pos4HeroId":"0","pos2":{"level":"7","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"9","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"沃伦","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":930,"evoLevel":"1","magOutPutAdd":0,"att":374,"advLevel":"0","dodge":40,"rebound":0,"ignoreDodge":50,"crit":120,"completePhyDef":0,"magDef":167,"hp":1302,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["903","1","1"],"2":["902","1","1"],"1":["901","1","1"],"10":["910","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13874","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":167},"speed":0,"userId":"3642","pos1HeroId":"13894","pos4":{},"echelon":"9","userPetId":"0","userPetInfo":{},"pos3HeroId":"13871","pos1":{"level":"1","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"32","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"尼古拉斯","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":960,"evoLevel":"1","magOutPutAdd":0,"att":151,"advLevel":"0","dodge":33,"rebound":0,"ignoreDodge":50,"crit":74,"completePhyDef":0,"magDef":113,"hp":667,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["3203","1","1"],"2":["3202","1","1"],"1":["3201","1","1"],"10":["3210","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13894","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":113},"userName":"紫罗兰末日堕天使","pos3":{"level":"12","magHarmAddRate":0,"critHarm":1500,"lifeStealRate":0,"heroId":"6","completeMagDef":0,"phyOutputAdd":0,"userId":"3642","nikename":"杰西卡","ignoreMagDef":50,"hpSegment":1,"phyHarmAddRate":0,"hit":950,"evoLevel":"1","magOutPutAdd":0,"att":384,"advLevel":"0","dodge":50,"rebound":0,"ignoreDodge":50,"crit":60,"completePhyDef":0,"magDef":364,"hp":2083,"magHarmAdd":0,"phyOutputAddRate":0,"skills":{"3":["603","1","1"],"2":["602","1","1"],"1":["601","1","1"],"10":["610","1","1"]},"morale":0,"completeMagDefAdd":0,"completePhyDefAdd":0,"ignorePhyDef":50,"userHeroId":"13871","lifeSteal":0,"replyMulti":0,"magOutputAddRate":0,"phyHarmAdd":0,"phyDef":234},"pos2HeroId":"13874","userUnionPkFormationId":"443"}',
			function(conn,reply)
				print(reply)
			end)
		
		client:Execute("set counter 1")

		for i = 1,1000 do
			local cmd = string.format("hmset chaid:%d chainfo %s skills %s",i,
									  "fasdfasfasdfasdfasdfasfasdfasfasdfdsaf",
									  "fasfasdfasdfasfasdfasdfasdfcvavasdfasdf")
			client:Execute(cmd)
		end

		for i = 1,1000 do
			request = request + 1
			local cmd = string.format("LPUSH list %d",i)
			client:Execute(cmd,function ()
				count = count + 1
				response = response + 1			
			end)
		end

		for i = 1,2 do
			request = request + 1
			local cmd = string.format("lpop list")
			client:Execute(cmd,gen_callback(pop_cb))
		end

		for i = 1,2 do
			request = request + 1
			local cmd = string.format("hmget chaid:%d chainfo skills",i)
		    client:Execute(cmd,gen_callback(query_cb,i))	
		end

		for i = 1,2 do
			request = request + 1
			client:Execute("incr counter",incr_cb)
		end
	end
end

local last = chuck.systick()
local t = chuck.RegTimer(engine,1000,function() 
	collectgarbage("collect") 
	local now = chuck.systick()
	print("hmget:" .. count*1000/(now-last) .. "/s" .. " request:" .. request .. " response:" .. response)
	last = now
	count = 0 
end)
signaler:Register(engine,sigint_handler)
engine:Run()






